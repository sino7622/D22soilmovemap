<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å…¨å°åœŸçŸ³æ–¹è³‡æºå †ç½®è™•ç†å ´åˆ†å¸ƒåœ°åœ–</title>

    <!-- Leaflet + Cluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", "Noto Sans TC", sans-serif;
            background: #f5f7fa;
            color: #333;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #1f3a5f;
            color: #fff;
            padding: 14px 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px 20px;
            gap: 12px;
            min-height: 0;
        }

        /* ä¸Šæ–¹ï¼šå·¥å…· + è³‡è¨ŠåŒä¸€è¡Œ */
        .top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* å·¦ï¼šæ›´æ–°è³‡æ–™ */
        .toolbar {
            display: flex;
            align-items: center;
        }

        /* å³ï¼šinfo-card + ä¸‹è¼‰æŒ‰éˆ•ç¾¤ */
        .right-panel {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .download-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #e0e6ed;
            color: #333;
            transition: all 0.2s ease;
            user-select: none;
            line-height: 1.1;
        }

        .btn:hover {
            background: #cfd8e3;
        }

        .btn-primary {
            background: #2563eb;
            color: #fff;
        }

        .btn-primary:hover {
            background: #1e4fd6;
        }

        .btn-success {
            background: #16a34a;
            color: #fff;
        }

        .btn-success:hover {
            background: #12803a;
        }

        .btn-danger {
            background: #dc2626;
            color: #fff;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .info-card {
            background: #fff;
            border-radius: 10px;
            padding: 8px 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            font-size: 13px;
            white-space: nowrap;
        }

        #infoCard {
            display: none;
        }

        /* åœ°åœ–é«˜åº¦è·Ÿç€è¦½å™¨èµ°ï¼šflex æ’æ»¿å‰©é¤˜é«˜åº¦ */
        #map {
            flex: 1;
            min-height: 520px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: #ddd;
            min-height: 0;
        }

        footer {
            padding: 10px 14px;
            text-align: center;
            font-size: 12px;
            color: #777;
            background: transparent;
        }

        @media (max-width: 768px) {
            .top-row {
                flex-direction: column;
                align-items: stretch;
            }

            .right-panel {
                justify-content: flex-start;
            }

            .info-card {
                white-space: normal;
            }
        }

        /* æŒ‡åŒ—é‡ */
        .north-arrow {
            position: relative;
            background: rgba(255, 255, 255, 0.92);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .north-arrow::before {
            content: 'â™¦';
            font-size: 30px;
            line-height: 1;
            display: block;
            color: #111;
            transform: translateY(1px);
        }

        .north-arrow::after {
            content: 'N';
            position: absolute;
            top: 2px;
            font-size: 12px;
            font-weight: 800;
            color: #111;
        }
    </style>
</head>

<body>
    <header>
        <h1>å…¨å°åœŸçŸ³æ–¹è³‡æºå †ç½®è™•ç†å ´åˆ†å¸ƒåœ°åœ–</h1>
    </header>

    <div class="container">
        <div class="top-row">
            <!-- å·¦ï¼šæ›´æ–° + KML ä¸Šå‚³ -->
            <div class="toolbar">
                <div class="download-group">
                    <a class="btn btn-primary" id="btnUpdate" href="javascript:void(0)" onclick="update()">ğŸ”„ æ›´æ–°è³‡æ–™</a>

                    <a class="btn btn-primary" href="javascript:void(0)"
                        onclick="document.getElementById('kmlUpload').click();">ğŸ“¤ ä¸Šå‚³ KML</a>
                    <input type="file" id="kmlUpload" accept=".kml" style="display:none;">
                </div>
            </div>

            <!-- å³ï¼šè³‡è¨Šå¡ + æ§åˆ¶ + ä¸‹è¼‰ -->
            <div class="right-panel">
                <div class="info-card" id="infoCard">
                    â± æ›´æ–°ï¼š<strong><span id="time"></span></strong>
                    ï½œ ğŸ“ ç­†æ•¸ï¼š<strong><span id="count"></span></strong>
                </div>

                <div class="download-group">
                    <a class="btn btn-success" id="btnToggleSuspended" href="javascript:void(0)"
                        onclick="toggleSuspended()">ğŸš« éš±è—æš«åœç«™é»</a>

                    <a class="btn btn-success" id="btnExcel" href="javascript:void(0)" target="_blank" rel="noopener">ğŸ“¥
                        Excel</a>
                    <a class="btn btn-success" id="btnKml" href="javascript:void(0)" target="_blank" rel="noopener">ğŸ“¥
                        KML</a>

                    <a class="btn btn-danger" href="https://www.soilmove.tw/" target="_blank"
                        rel="noopener noreferrer">ğŸŒ è³‡æ–™ä¾†æºï¼šç‡Ÿå»ºå‰©é¤˜åœŸçŸ³æ–¹è³‡è¨Šæœå‹™ä¸­å¿ƒ</a>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <footer>
        æœ¬ç³»çµ±åƒ…ä½œè³‡æ–™è¦–è¦ºåŒ–å±•ç¤ºï¼Œå¯¦éš›è³‡è¨Šè«‹ä»¥å®˜æ–¹è³‡æ–™ä¾†æºç‚ºæº–<br />
        <span style="color:#999;">Â© æœ¬ç¶²ç«™ç‚ºä¸­èˆˆå·¥ç¨‹åœ’è·¯éƒ¨é–‹ç™¼åŠç¶­è­·ï¼ˆç‰ˆæœ¬ï¼šv1ï¼‰</span>
    </footer>

    <!-- JS libs -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- KML -> GeoJSON -->
    <script src="/static/togeojson.js"></script>

    <!-- Proj4 (EPSG:3826 -> 4326) -->
    <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>

    <script>
        // =========================
        // 0) åŸºæœ¬è¨­å®š
        // =========================
        const SOILMOVE_LIST_URL = "https://www.soilmove.tw/soilmove/dumpsiteGisQueryList";
        const SOILMOVE_REFERER = "https://www.soilmove.tw/soilmove/dumpsiteGisQuery";

        // localStorage key
        const LS_KEY = "soilmove_cache_v1";

        // æ§åˆ¶ UI
        function setInfoCardVisible(isVisible) {
            const el = document.getElementById("infoCard");
            if (!el) return;
            el.style.display = isVisible ? "block" : "none";
        }

        function setBtnLoading(btnEl, loadingText, normalText, isLoading) {
            if (!btnEl) return;
            if (isLoading) {
                btnEl.classList.add("disabled");
                btnEl.style.pointerEvents = "none";
                btnEl.textContent = loadingText;
            } else {
                btnEl.classList.remove("disabled");
                btnEl.style.pointerEvents = "auto";
                btnEl.textContent = normalText;
            }
        }

        function nowTaipeiString() {
            // ä¸é å¾Œç«¯ï¼Œç›´æ¥ç”¨ç€è¦½å™¨æ™‚é–“
            const d = new Date();
            const pad = (n) => String(n).padStart(2, "0");
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        // =========================
        // 1) åº§æ¨™æ­£è¦åŒ–ï¼ˆæ”¯æ´ï¼šç¶“ç·¯åº¦ / åè½‰ / TWD97(TM2) å¸¸è¦‹å…¬å°ºåº§æ¨™ï¼‰
        // =========================
        // å‰ç«¯è¦åš TWD97 â†’ WGS84 éœ€è¦ proj4
        // ä½ å·²ç¶“æœ‰å¼•å…¥ï¼šhttps://unpkg.com/proj4@2.9.2/dist/proj4.js
        // å®šç¾© EPSG:3826ï¼ˆTWD97 / TM2(121)ï¼‰
        if (typeof proj4 !== "undefined") {
            proj4.defs("EPSG:3826", "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +units=m +no_defs");
        }

        function looksLikeLngLat(lng, lat) {
            return (lng > 118 && lng < 125) && (lat > 20 && lat < 26.5);
        }

        function looksLikeTWD97(x, y) {
            return (x >= 100000 && x <= 400000) && (y >= 2000000 && y <= 3200000);
        }

        function normalizeCoords(obj) {
            // soilmove åŸå§‹æ¬„ä½ï¼šx, yï¼ˆå¯èƒ½å­—ä¸²ï¼‰
            const v1 = parseFloat(obj.x || 0);
            const v2 = parseFloat(obj.y || 0);

            // A) å·²æ˜¯ç¶“ç·¯åº¦ï¼ˆx=lng, y=latï¼‰
            if (looksLikeLngLat(v1, v2)) return { lng: v1, lat: v2, coord_status: "åŸå§‹ç¶“ç·¯åº¦" };

            // B) åè½‰å¾Œæ˜¯ç¶“ç·¯åº¦ï¼ˆx=lat, y=lngï¼‰
            if (looksLikeLngLat(v2, v1)) return { lng: v2, lat: v1, coord_status: "å·²ä¿®æ­£(X/Yåè½‰â†’ç¶“ç·¯åº¦)" };

            // C) TWD97(TM2 3826) â†’ WGS84
            if (typeof proj4 !== "undefined" && looksLikeTWD97(v1, v2)) {
                const [lng, lat] = proj4("EPSG:3826", "EPSG:4326", [v1, v2]);
                if (looksLikeLngLat(lng, lat)) return { lng, lat, coord_status: "TWD97(TM2 3826)â†’WGS84 è½‰æ›" };
            }

            // D) åè½‰å¾Œæ˜¯ TWD97
            if (typeof proj4 !== "undefined" && looksLikeTWD97(v2, v1)) {
                const [lng, lat] = proj4("EPSG:3826", "EPSG:4326", [v2, v1]);
                if (looksLikeLngLat(lng, lat)) return { lng, lat, coord_status: "å·²ä¿®æ­£(X/Yåè½‰)+TWD97â†’WGS84 è½‰æ›" };
            }

            return { lng: 0, lat: 0, coord_status: "åº§æ¨™ç•°å¸¸/æœªèƒ½è¾¨è­˜åº§æ¨™ç³»çµ±" };
        }

        // =========================
        // 2) è½‰æˆå‰ç«¯ render() éœ€è¦çš„è³‡æ–™çµæ§‹ï¼ˆç¶­æŒä½ åŸæœ¬æ¬„ä½ï¼‰
        // =========================
        function shapeForMap(rawList) {
            const out = [];
            (rawList || []).forEach(d => {
                const { lng, lat, coord_status } = normalizeCoords(d);

                if (lng > 0 && lat > 0) {
                    out.push({
                        dumpname: d.dumpname || "æœªå‘½å",
                        city: d.city || "",
                        typename: d.typename || "",
                        controlId: d.controlId || "",
                        applydate: d.applydate || "",
                        remain: d.remain || "",
                        maxbury: d.maxbury || "",
                        area: d.area || "",
                        lng, lat,
                        coord_status
                    });
                }
            });
            return out;
        }

        // =========================
        // 3) localStorageï¼šè®€/å¯«å¿«å–
        // =========================
        function saveCache(payload) {
            try {
                localStorage.setItem(LS_KEY, JSON.stringify(payload));
            } catch (e) {
                console.warn("localStorage å¯«å…¥å¤±æ•—ï¼š", e);
            }
        }

        function loadCache() {
            try {
                const s = localStorage.getItem(LS_KEY);
                if (!s) return null;
                return JSON.parse(s);
            } catch (e) {
                console.warn("localStorage è®€å–å¤±æ•—ï¼š", e);
                return null;
            }
        }

        // =========================
        // 4) çœŸçš„å»æŠ“ soilmoveï¼ˆå‰ç«¯ fetchï¼‰
        // =========================
        async function fetchSoilmove() {
            // soilmove é€™æ”¯é€šå¸¸éœ€è¦ POST city=''ï¼Œä¸”æœ‰ Referer / X-Requested-With
            // âš ï¸ æ³¨æ„ï¼šç€è¦½å™¨æœƒé™åˆ¶ä½ è‡ªè¨‚ Refererï¼Œé€™æ˜¯æ­£å¸¸çš„
            // æˆ‘å€‘ç›¡é‡å¸¶ X-Requested-Withï¼Œä¸¦ç”¨ form-urlencoded
            const body = new URLSearchParams({ city: "" });

            const resp = await fetch(SOILMOVE_LIST_URL, {
                method: "POST",
                mode: "cors", // è‹¥å°æ–¹ä¸é–‹ CORSï¼Œæœƒç›´æ¥è¢«ç€è¦½å™¨æ“‹ï¼ˆä¸æ˜¯ä½ çš„éŒ¯ï¼‰
                headers: {
                    "Accept": "application/json, text/javascript, */*; q=0.01",
                    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body
            });

            if (!resp.ok) {
                throw new Error(`soilmove fetch failed: HTTP ${resp.status}`);
            }

            // æœŸå¾… JSON
            const ct = (resp.headers.get("content-type") || "").toLowerCase();
            if (!ct.includes("application/json")) {
                const text = await resp.text();
                throw new Error(`soilmove non-json: ${ct} head=${text.slice(0, 120)}`);
            }

            return await resp.json();
        }

        // =========================
        // 5) Updateï¼šæŒ‰ä¸€ä¸‹å°±æŠ“æœ€æ–° + å­˜å¿«å– + render
        // =========================
        async function update() {
            const btn = document.getElementById("btnUpdate");
            setBtnLoading(btn, "â³ æ›´æ–°ä¸­...", "ğŸ”„ æ›´æ–°è³‡æ–™", true);
            setInfoCardVisible(false);

            try {
                const raw = await fetchSoilmove();
                const data = shapeForMap(raw);

                const payload = {
                    updated: nowTaipeiString(),
                    count: data.length,
                    data
                };

                // æ›´æ–°ç•«é¢
                const timeEl = document.getElementById("time");
                const countEl = document.getElementById("count");
                if (timeEl) timeEl.innerText = payload.updated;
                if (countEl) countEl.innerText = payload.count;

                // äº¤çµ¦ä½ åŸæœ¬çš„ render(data)
                // render å…§éƒ¨æœƒè™•ç† showSuspended / marker icon / popup ç­‰
                if (typeof render === "function") render(payload.data);

                // å­˜ localStorage
                saveCache(payload);

                // é¡¯ç¤º info card
                setInfoCardVisible(true);

                alert(`æ›´æ–°å®Œæˆï¼Œå…± ${payload.count} ç­†è³‡æ–™`);
            } catch (err) {
                console.error(err);

                // è‹¥æŠ“ä¸åˆ°ï¼Œå˜—è©¦ç”¨å¿«å–æ•‘å ´
                const cached = loadCache();
                if (cached && cached.data && cached.data.length) {
                    const timeEl = document.getElementById("time");
                    const countEl = document.getElementById("count");
                    if (timeEl) timeEl.innerText = `${cached.updated}ï¼ˆå¿«å–ï¼‰`;
                    if (countEl) countEl.innerText = cached.count;
                    if (typeof render === "function") render(cached.data);
                    setInfoCardVisible(true);
                    alert("âš ï¸ ç„¡æ³•å–å¾—æœ€æ–°è³‡æ–™ï¼Œå·²æ”¹ç”¨æœ¬æ©Ÿå¿«å–é¡¯ç¤ºã€‚");
                } else {
                    alert("âŒ æ›´æ–°å¤±æ•—ï¼šå¯èƒ½æ˜¯ soilmove æœªé–‹æ”¾è·¨ç¶²åŸŸï¼ˆCORSï¼‰æˆ–æš«æ™‚é˜»æ“‹ã€‚\nè«‹æŸ¥çœ‹ Consoleã€‚");
                }
            } finally {
                setBtnLoading(btn, "â³ æ›´æ–°ä¸­...", "ğŸ”„ æ›´æ–°è³‡æ–™", false);
            }
        }

        // =========================
        // 6) ç¶²é è¼‰å…¥æ™‚ï¼šå…ˆè¼‰å¿«å–ï¼ˆä¸ç”¨æ¯æ¬¡éƒ½æ‰“ï¼‰
        // =========================
        document.addEventListener("DOMContentLoaded", () => {
            const cached = loadCache();
            if (cached && cached.data && cached.data.length) {
                const timeEl = document.getElementById("time");
                const countEl = document.getElementById("count");
                if (timeEl) timeEl.innerText = `${cached.updated}ï¼ˆå¿«å–ï¼‰`;
                if (countEl) countEl.innerText = cached.count;

                if (typeof render === "function") render(cached.data);
                setInfoCardVisible(true);
            } else {
                // æ²’å¿«å–å°±å…ˆéš±è—è³‡è¨Šå¡
                setInfoCardVisible(false);
            }
        });

        // æŠŠ update æ›åˆ°å…¨åŸŸï¼Œè®“ä½ çš„ <a onclick="update()"> å¯ç”¨
        window.update = update;
    </script>

</body>

</html>